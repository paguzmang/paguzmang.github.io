---
title: "Análisis de Datos Categóricos"
subtitle: "Bioestadística II"
author: "pguzman"
date: "Mayo 2019"
output:
  xaringan::moon_reader:
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

```{r, include = F}
library(knitr)
opts_chunk$set(fig.align = 'center', warning = F, message = F)
library(tidyverse)
```


# Introducción

Las variables categóricas son aquellas que toman valores de texto (no numéricos), por ejemplo, 

- la presencia o ausencia de una especie en una parcela ecológica, 

- tipo de sangre (A,B,O,AB) de una persona, 

- genotipos posibles (AA, Aa, aa) para un gen particular en un individuo diploide, etc.

En este capítulo aprenderemos como probar hipótesis en el contexto de datos categóricos

---
class: center, middle, inverse

# Estadística descriptiva en datos categóricos

---

# Estadística descriptiva en datos categóricos

La forma usual de resumir los resultados para una variable categórica es _contando_ el número de individuos en la muestra con cada categoría. 

Este conteo se llama _frecuencia absoluta_; para complementar este resumen también  se cálcula la _frecuencia relativa_ o _proporción_ de sujetos en cada categoría. 

--

**Ejemplo**

```{r, include = F}
d1 <- read.table(file = 'rare_plants_agrup.txt', header = T, sep = ' ')
library(vcdExtra)
rare_plants <- expand.dft(d1, freq = 'frequency')
write.table(x = rare_plants, file = 'rare_plants.txt', sep = '\t', 
            quote = F, row.names = F)
```


Un estudio pretendió evaluar factores asociados con el estatus de conservación de 73 poblaciones de plantas raras en Nueva Inglaterra. A cada población se le identificó :

- si estaba declinando en tamaño o no, 
- si esta legalmente protegida o no, 
- la presencia o no de especies invasoras en su habitat
- cinco niveles cualitativos de intensidad de luz (0 para mucha sombra a 4 para sol brillante)


---

# Estadística descriptiva en datos categóricos

```{r}
# Lectura de datos
rare_plants <- read.table(file = 'rare_plants.txt', 
                          header = T, sep = '\t')
str(rare_plants)
head(rare_plants, 4)
```

---

# Estadística descriptiva en datos categóricos

```{r}
# Tabla de frecuencias (absolutas) de decline:
xtabs(~ decline, data = rare_plants)
```

```{r}
# Tabla de frecuencias (relativas) de decline:
prop.table(
  xtabs(~ decline, data = rare_plants)
)
```

---

# Estadística descriptiva en datos categóricos

**Tablas de frecuencia o de contingencia de dos vías**

Los estudios involucran por lo general, dos o más variables categóricas. Por ejemplo, para el estudio sobre plantas raras puede ser de interés explorar la relación entre el estatus de declina de la población y si la población se encontró protegida o no.

Cuando se busca relacionar dos variables, se construye una tabla de contingencia de dos vías:

```{r}
# Tabla de contingencia 2 x 2:
addmargins(
  xtabs(~ protected + decline, data = rare_plants)
)
```

---
# Estadística descriptiva en datos categóricos

**Gráfico de barras para dos variables categóricas**


.pull-left[
```{r, fig.show='hide'}
library(dplyr)
library(ggplot2)
# Grafico de barras
xtabs(~ protected + decline, 
      data = rare_plants) %>%
  prop.table() %>% 
  as.data.frame() %>%
  ggplot(aes(x = protected , 
             y = Freq, 
             fill = decline)) +
  geom_col(
    position = position_dodge())
```
]

.pull-right[
```{r, echo = F, fig.height=4, fig.width = 3.9, out.width='90%'}
xtabs(~ protected + decline, data = rare_plants) %>%
  prop.table() %>% as.data.frame() %>%
  ggplot(aes(x = protected , y = Freq, fill = decline)) +
  geom_col( position = position_dodge())
```
]



---

# Estadística descriptiva en datos categóricos

**Tablas de frecuencia o de contingencia de dos vías**

```{r}
# Tabla de contingencia 5 x 2: Luz x declina
addmargins(
  xtabs(~ light + decline, data = rare_plants)
)
```


---

# Estadística descriptiva en datos categóricos

**Calculando proporciones desde tablas de contigencia**

La proporción (o frecuencia relativa) permite resumir una variable categórica con dos categorías.

```{r}
tab1 <- xtabs(~ light + decline, data = rare_plants)

# Proporcion de declive por nivel de luz:
tab1.prop <- prop.table(tab1, 1)
tab1.prop
```

---

class: center, middle, inverse

# Pruebas Chi-cudrado con datos categóricos

---

# Diferentes objetivos con datos categóricos

Cuando un estudio se centra en el análisis de variables categóricas, tres tipos de pruebas de inferencia estadística se podrían requerir dependiendo de los objetivos del estudio:

- Evaluar el ajuste de los datos a un modelo de probabilidad particular (_Pruebas de Bondad de ajuste_).  

- Comparación de dos (o más) grupos para una respuesta categórica (_Pruebas de homogeneidad_).

- Asociación entre dos (o más) variables categóricas (_Pruebas de independencia_). 

---

# Estadístico de prueba general

Todas estas pruebas se pueden abordar con un estadístico de prueba general dado por:

$$ X^2 = \sum \dfrac{(o - e)^2}{e}\, \quad \text{donde } o = \text{frec. observadas y } e =  \text{frec. esperadas bajo H$_0$} $$

- Las frec. observadas corresponden a las frec. absolutas obtenidas desde los datos. El cálculo de las frec. esperadas  depende de como este planteada $H_0$, lo cual es particular a cada tipo de prueba. 

- Si las frecuencias observadas y esperadas (bajo $H_0$) son similares, el estadístico $X^2$ sera pequeño (cercano a 0), lo cual apoyará la retención de $H_0$. Ocurre lo contrario, si las frec. observadas y esperadas son diferentes, el estadístico $X^2$ será grande (positivo) y esto apoyará el rechazo de $H_0$.

- Si $H_0$ es cierta, el estadístico $X^2$ sigue una distribución de probabilidad llamada _Chi-cuadrado_

---

# Modelo Chi-cuadrado

- Este modelo de probabilidad tiene un sólo parámetro llamado los _grados de libertad_, $v$, el cuál es un entero positivo.

- Un variable aleatoria chi-cuadarado con $v$ grados de libertad es continua y sólo toma valores positivos.

- Su forma tiene una asimetría positiva marcada (similar a la $F$) como se muestra en el siguiente dibujo:

```{r, echo = F, fig.width=5, fig.height=3, out.width='70%'}
par(mar = c(3.5,5,2,1), mgp = c(2.1,0.3,0), cex = 1.2, las = 1, bty = 'l', 
    tcl = -0.2, col.axis = 'grey50', col.lab = 'grey50')
curve(dchisq(x, df = 3), xlim = c(0,30), lwd = 2, ylab = "Densidad",
      xlab = expression(chi[v]^2), main = "Curvas Chi-cuadrado", axes = F)
curve(dchisq(x, df = 8), xlim = c(0,30), lwd = 2, col = "red", add = T)
curve(dchisq(x, df = 14), xlim = c(0,30), lwd = 2, col = "blue", add = T)
legend(x = 10, y = 0.2, legend = c("v = 3","v = 8","v = 14"), 
       col = c("black","red","blue"), bty = "n", lty = 1, lwd = 2)
axis(side = 1)
```


---

# Modelo Chi-cuadrado

- El valor esperado o media de una $\chi^2_v$ es $v$. 

- Las probabilidades y cuantiles del modelo $\chi^2$ se han tabulado. A continuación se muestra un parte de la tabla $\chi^2_v$ hasta $v = 6$ grados de libertad:

```{r, echo=F}
include_graphics('Tabla_Chisq.png')
```

---

# Forma general para rechazar $H_0$ en pruebas Chi-cuadrado

La forma de rechazar $H_0$ usando el estadístico $X^2$ es la siguiente:


- Se rechaza $H_0$ si el valor $p = P(\chi^2_v > X^2) < \alpha$, ó,

- se rechaza $H_0$ si el $X^2 > \chi^2_{v,1-\alpha}$, donde $\chi^2_{v,1-\alpha}$ es un cuantil de la Chi-cuadrado con $v$ grados de libertad y que deja una probabilidad $1-\alpha$ por debajo.

- Los grados de libertad, $v$, se calculan de acuerdo a cada prueba.

---
class: center, middle, inverse

# Pruebas de bondad de ajuste
---

# Pruebas de bondad de ajuste

En este tipo de pruebas, se evalua si la distribuición de frecuencias de cierta variable categórica se ajusta a una distribución de probabilidad teórica establecida en $H_0$.

--

**Ejemplo**

Se cuenta con los registros del tipo de sangre (A, B, O, AB) de $n = 142$ sujetos que donaron sangre durante una jornada de donación de sangre en un centro médico. Los conteos observados por tipo de sangre fueron:

|  A |  B |  O | AB | Total |
|---:|---:|---:|---:|------:|
| 57 | 15 | 63 | 7  | 142   |

Pruebe la hipótesis nula de que los tipos de sangre son igualmente probables en la población bajo estudio. Use  $\alpha = 0.05$.

---

# Pruebas de bondad de ajuste: Ejemplo

El modelo de interés es que los cuatros tipos sanguíneos tienen la misma probabilidad de ocurrir en la población. Si existen $k = 4$ categorías entonces la probabilidad de ocurrencia esperada para cada tipo sanguíneo sería $1/k = 1/4$. 

En este tipo de pruebas, el modelo de probabilidad de interés se ubica en $H_0$, luego, las hipótesis nula y alterna para este ejemplo son:

 $$H_0: \pi_A = \pi_B = \pi_O = \pi_{AB} = 1/4\quad\text{ contra }\quad H_1:\text{Al menos  un } \pi_i \neq 1/4$$

con $i = \{A, B, AB, O\}$ y $\pi_i$ es la frecuencia relativa (probabilidad o proporción) _esperada_ o poblacional para la $i-$ésima categoría; en este caso, para el $i-$ésimo grupo sanguíneo.

```{r, include = F}
obs <- c(57, 15, 63, 7)
n <- sum(obs)
n*0.25
X2 <- sum( (obs - n*0.25)^2/(n*0.25) )
p <- pchisq(q = X2, df = 3, lower.tail = F)
```

 
---

# Pruebas de bondad de ajuste: Ejemplo

Si se _espera_ que cada grupo sanguíneo este representado en $1/4$ de la población, entonces las frecuencias absolutas (o conteos) esperados para una muestra de $n = `r n`$ sujetos es de

$$e_{A} = e_{B} = e_{AB} = e_{O} = n \times (1/4) = `r n` \times (1/4) = `r n*0.25`$$

Así, las frecuencias observadas y esperadas son:

|       |    A |    B |    O | AB   | Total |
|-------|-----:|-----:|-----:|-----:|------:|
| $o_i$ |   57 |   15 |   63 | 7    | 142   |
| $e_i$ | 35.5 | 35.5 | 35.5 | 35.5 | 142   |

El cálculo del estadístico de prueba es:

$$X^2 = \sum_{i = 1}^4 \dfrac{(o_i - e_i)^2}{e_i} = \dfrac{(57 - 35.5)^2}{35.5} + \cdots + \dfrac{(7 - 35.5)^2}{35.5} = `r round(X2,2)`$$

Se rechaza $H_0$ dado que el valor $p = P(\chi^2_3 > 69.4) < 0.01$.

---

# Pruebas de bondad de ajuste: Ejemplo

Dado que $X^2 = 69.4$ es grande esto sugiere un apoyo para el rechazo de $H_0$. Los grados de libertad de la prueba son $k-1$ donde $k$ es el número de categorías que se evaluan. En este caso, $k = 4$ y $v = 4 - 1 = 3$.

El valor $p = P(\chi^2_3 > 69.4) < 0.01$. Usando un $\alpha = 0.05$, se rechaza $H_0$ y se concluye, con una evidencia fuerte, que los tipos de sangre no son igualmente probables en la población. 

---
class: center, middle, inverse

# Pruebas de Homogeneidad

---

# Pruebas de Homogeneidad

En una prueba de homogeneidad se compara la distribución de cierta variable respuesta categórica entre los grupos formados por otra variable categórica. 

--

**Ejemplo**

Una población de truchas en una región está siendo afectada por una bacteria. Para estudiar como cambia la prevalencia de la infección, se tomó una muestra de 94 individuos en una época seca y otra muestra de 99 individuos en una época lluviosa. Para cada pez se determinó mediante métodos moleculares la presencia de la bacteria.  Los datos se han organizado en la siguiente tabla de conteo $2 \times 2$:

|Época     | Si | No | Total |
|:---------|---:|---:|------:|
| Seca     | 36 | 58 | 94    |
| LLuviosa | 14 | 85 | 99    |

Pruebe que la prevalencia de la infección es la misma en las dos épocas. Use $\alpha = 0.05$.


---
class: center, middle, inverse

# Pruebas de Independencia

---

# Pruebas de Independencia

En est tipo de pruebas se busca evaluar si dos variables categóricas son independientes o no están asociadas. Este tipo de pruebas se derivan de un diseño donde existe _una sóla muestra_ de "sujetos" los cuales son clasificados simultaneamente para dos o más variables categóricas.

--

**Ejemplo**

En el ejemplo de las plantas raras en Nueva Inglaterra, evaluar si el estatus de la población esta asociado con el hecho de que la zona sea protegida o no. Use $\alpha = 0.05$.


